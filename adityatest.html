<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Example</title>
  </head>
  <body>
    <script>
      const URI = "wss://sons-feed-dont-pen.trycloudflare.com/api/v1/stream";
      const user_input =
        "Please give me a step-by-step guide on how to plant a tree in my backyard.";
      const history = { internal: ["i have a small backyard"], visible: [] };

      const request = {
        user_input: user_input,
        prompt: user_input,
        max_new_tokens: 250,
        auto_max_new_tokens: false,
        history: history,
        mode: "instruct",
        character: "Example",
        instruction_template: "Vicuna-v1.1",
        your_name: "You",
        // 'name1': 'name of user', // Optional
        // 'name2': 'name of character', // Optional
        // 'context': 'character context', // Optional
        // 'greeting': 'greeting', // Optional
        // 'name1_instruct': 'You', // Optional
        // 'name2_instruct': 'Assistant', // Optional
        // 'context_instruct': 'context_instruct', // Optional
        // 'turn_template': 'turn_template', // Optional
        regenerate: false,
        _continue: false,
        chat_instruct_command:
          'Continue the chat dialogue below. Write a single reply for the character "".\n\n',
        preset: "None",
        do_sample: true,
        temperature: 0.7,
        top_p: 0.1,
        typical_p: 1,
        epsilon_cutoff: 0,
        eta_cutoff: 0,
        tfs: 1,
        top_a: 0,
        repetition_penalty: 1.18,
        repetition_penalty_range: 0,
        top_k: 40,
        min_length: 0,
        no_repeat_ngram_size: 0,
        num_beams: 1,
        penalty_alpha: 0,
        length_penalty: 1,
        early_stopping: false,
        mirostat_mode: 0,
        mirostat_tau: 5,
        mirostat_eta: 0.1,
        guidance_scale: 1,
        negative_prompt: "",
        seed: -1,
        add_bos_token: true,
        truncation_length: 2048,
        ban_eos_token: false,
        skip_special_tokens: true,
        stopping_strings: [],
      };

      const ws = new WebSocket(URI);
      let message = "";
      ws.onopen = () => {
        message = "";
        console.log("Connected to WebSocket server");
        ws.send(JSON.stringify(request));
      };

      ws.onmessage = (event) => {
        const incomingData = JSON.parse(event.data);
        // Process incomingData here
        console.log("Received:", incomingData);
        message += incomingData.text;
        document.getElementById("message").innerHTML = message;
      };

      ws.onclose = (event) => {
        message = "";

        if (event.wasClean) {
          console.log(
            `Connection closed cleanly, code=${event.code}, reason=${event.reason}`
          );
        } else {
          console.error("Connection died");
        }
      };

      ws.onerror = (error) => {
        console.error("WebSocket Error:", error);
      };
    </script>

    <p id="message"></p>
  </body>
</html>
